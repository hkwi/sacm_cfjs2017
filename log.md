---
layout: default
---
[Code for Japan SUMMIT 2017](https://summit2017.code4japan.org/) というイベントのネットワーク環境運用の知見を共有すべく記事にまとめてみる。お約束だけれども、この記事は会社の意見を代表するものではありません。また当然のことながら、特定の会社・団体の評判を上げたり下げたりする意図の記事でもありません。どのぐらいの規模で、どういった状況で、どうなったのか、という参考値を共有するためのものです。

見積もり
========

Code for Japan SUMMIT 2016 の[実績値は 650 人](https://medium.com/code-for-japan/code-for-japan-summit-2016-%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88-%E3%83%97%E3%83%AC%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E7%B7%A8-86418045a810)でした。前回は神奈川県横浜市金沢区総合庁舎で開催されています。今回は神戸の「しあわせの村」という施設が会場でした。地図を見ると分かりますが、街中ではないので「フレッツいっちょ」とは行きません。会場には[神戸市の Free Wi-Fi](http://www.city.kobe.lg.jp/culture/leisure/information/kobefreewifi.html)があるようでしたが、インターネットを使うようなイベントは開催したことがないというお話でしたので、普通にやるとパンクしそうです。Ethernet のコンセントもありませんし、会場設営に使える時間も非常にタイトでした。

「関西で人が集まるのか？」「山の中までみんな来るのか？」そもそも正直来場者が何人になるのか見当がつきません。とりあえず昨年同様と仮置きします。

ちなみに「しあわせの村」という単語を聞くと、何やら怪しげな印象を持ってしまいそうですが、実際は神戸市の外郭団体「公益財団法人こうべ市民福祉振興協会」運営で「ユニバーサルデザイン」の[実験施設](http://www.shiawasenomura.org/ud_u.html)といったものです。

事前準備
========

最終的なプランは Wi-Fi AP から、上流の DoCoMo LTE 網経由で、それぞれ直接インターネットに抜けていく構成です。

初期準備機材
- 業務用 AP（x10）
  - IIJ [SACM SA-W2](http://www.sacm.jp/#saw2)
  - [IIJ mobile タイプD 定額プランL](https://www.iij.ad.jp/biz/iijmobile/plan_l/plan.html) 
  - [IIJ mobile 端末レンタル UX312NC](https://www.iijmobile.jp/product/type_d/card_UX312NC.html)
- ポケット Wi-Fi（x4）
  - [NTT DOCOMO Wi-Fi STATION N-01H](https://www.nttdocomo.co.jp/product/data/n01h/) /
    [NTT DOCOMO Wi-Fi STATION N-01J](https://www.nttdocomo.co.jp/product/data/n01j/)
  - [IIJmio プリペイドパック](https://s.iijmio.jp/prepaid/)

明らかに普通じゃないです。たぶん昨今普通の構成はフレッツ上流の Wireless Controller 制御の Wi-Fi AP 群でしょう。この構成になった一番の理由は、上流回線に有線が引けなかったためです。Wireless Controller を使う場合と比べて、電波環境に対して AP 群全体で自動調節機能がない、ローミングがシームレスには行われない、といったデメリットは存在します。ただ、電源を入れるだけでデプロイが完了するのは大きなメリット。設営・撤収時間も限られていたので、有線 LAN ケーブル敷設が必要ないのは大変助かります。

会場全体の Wi-Fi の認証情報は基本的に共通設定にして、スポットで使用するものは隔離するようにしました。

運用は基本一人なので、SACM のテンプレートで設定を管理しつつ、[モニタリング](https://hkwi.github.io/sacm_cfjs2017/)ツールを追加します。今回は携帯網に直接抜けるので、SIM の積算通信量が大事なメトリクスでした。一般的な構成で上流の回線が flets などであれば、帯域が大事になってくるので、瞬間瞬間のビットレートをモニタしています。今回は変則的です。

今回の IIJmobile のプランでは SIM 1 枚につき 10G の通信容量が割当たっています。総量 100G を多いとみるか少ないとみるか。IIJmio の容量 2G の総量 8G を多いとみるか少ないとみるか。とりあえず「足りて欲しい信じてる」と自分に言い聞かせながら準備を終えました。

初日
====

会場の定員数をベースに割り振っていきます。SA-W2 は大雑把に言って、定員 50 人につき 1 台の割り当てを行ないました。

|会場|設置数|
|:---|:---|
|ホール|3|
|大会議室|2|
|研修室 1|1|
|研修室 2|1|
|研修室 3|1|
|受付・廊下|1|
|ワークショップ用（別SSID）|1|
|動画配信|pocketWi-Fi x1|

金属製の手すり、窓枠に注意しながら機材設置を行います。できれば人の高さよりも高い位置に。調理室はステンレスだらけでどうしようかと思った。調理台に素朴に置いたら全く通信できないのね。ステンレス強い。

開始早々に控室にも欲しいというリクエストで、ポケット Wi-Fi を設置。

動画中継用には、ポケット Wi-Fi を有線接続して使用していただいた。

朝から「iPhone で Facebook メッセンジャーが動かない」「入れなおしたら動いたよ」という会話が飛び交っていたので、嫌な予感が…。ちょうど iPhone 8 のリリースに備えて iOS アップデートが配られ始めていたそうですね。

![設置の様子](https://farm5.staticflickr.com/4430/23473395248_93c00b6f5c.jpg)

蓋を開けてみれば、控室設置のポケット Wi-Fi の 2G は気が付いたら 1.9G 蒸発していて、動画用のは 2G を 1 時間で消費してしまった！
特に動画のほうが問題なので、急遽本体ごと置き換えて次の 2G を使い始めました。
しかしその 2G を使い切るのも時間の問題なので、対策すべく最寄りの（といっても遠い！）セブンイレブンにて [10G クーポン](https://s.iijmio.jp/couponcard/code.html) x 4を購入（オンラインで購入できたらいいのにな）。「じゅう」G クーポンなので「重」課金です（1万円くらいでした）。動画用は 12G に伸ばしてとりあえずイベント期間はカバーできる見通しに。4 枚購入したのは、いろんなやりくり方法を考えると、結局 IIJmio SIM で伸ばせるようにするしかない、と決断しました。消費が早ければ 2G はあっという間になくなります。5G は傾向は見えてきますが、手を打つ時間が残っていない感じです。10G あれば傾向を読みながらローテーションを組みなおすことができる、という感じでした。

猛烈に消費されていく「ギガ」を見て、冷や汗をかきながら「何とか初日はちょうど燃え尽きて終わりそう」という見通しを立てます。初日を終えた時点で、[モニタのグラフ](https://hkwi.github.io/sacm_cfjs2017/)で、ちょうど `dev07` と `dev08` の 10G が燃え尽きていることを確認。つまりホールの前付近が綺麗に燃え尽きたわけだ。足りなかったわけではなかったので、とりあえず乗り切った。会場の部屋の施錠も早いし、とりあえずみんなと呑むしかない。問題は 2 日目だよ…。

二日目
======
初日には、こんな割り当てにしていました。どうなるかわからないので、エイヤで。

![Deploy1](https://docs.google.com/drawings/d/e/2PACX-1vRECx3AqPfrAz4BgBkgOz_h_yudsKqkTSmuRsrnXJkhatij2ZKAc7iGaQttKTXEkjLpXIrKopxa_RU1/pub?w=480&h=360)

グラフから消費量を読み取る。受け付けまわり意外と使わないのね。

|消費量|AP|
|:--|:--|
|10G|dev07, dev08|
|6G|dev03|
|5.5G|dev09|
|5G|dev01, dev02|
|1.5G|dev04, dev05, dev06|

二日目には、ローテーションをかけながらこんな割り当てにしました。大会議室からホールに一台移動して強化。

![Deploy2](https://docs.google.com/drawings/d/e/2PACX-1vQcMYnPbOlryq3eHxsAJ3PLnEfoBPqESO30e0PYmfVEFVDHNHEWPeisYrXcJvSk8Ut-4DZG5ShWufZU/pub?w=480&h=360)

どうやら私が苦しんでいるのを見て、iOSアップデートは控えるように、というアナウンスをしていただけたらしい。結果的には大変助かりました。しかし技術的には、安心して Wi-Fi を使用できる環境を整えたほうが、結果的にも電波環境が安定してよいということもあり、若干複雑な気持ちではあります。だって、使うなと言われたら自分の携帯で Wi-Fi テザリング始めるでしょう？そうすると電波環境はますます混雑してしまうのです（実際 24 日のほうが 2.4GHz 帯の外来波は強く出ています）。どうにもならない。とにかく頑張ろう。

SIM カードを入れ替えることも考えたけれど、現場ではリスクの高いオペレーションになるので、SA-W2 の上流に無線を出さないポケット Wi-Fi を入れる、という構成にして投入しました。Ethernet 接続。

キッズ向けの workshop 用に設置していた無線 LAN は、SSID を異なるものにしていたけれど、気が付いたらたくさん人が繋がっていて 4G 以上消費されていました（`dev10`）。パスワード同じにしていたから仕方がないとはいえ、油断していた。残り 6G で大人気 Minecraft ワークショップを賄えるか？無理だった時どうする？というアレコレを考えつつ、とりあえずパスワードを変更。AP の設定もリブートなしでルーティング変更で移行できるようにしました。適当なタイミングで重課金 SIM のポケット Wi-Fi 経由に経路を切り替えました。なるほど Minecraft ワークショップ、バージョンを揃えるためにゲームをダウンロードし直すので、それなりに消費するのね。実は切り替え実施タイミングが少し遅くて、完全に使い切ったタイミングが出てしまっていた様子。何人か接続が切れてしまったようで、申し訳ないことをした。

最終的には「何とか乗り切った？」という感じ。動画配信は有線接続していただけたおかげで、Wi-Fi 由来のトラブルには巻き込まれずに済みました。よかったよかった。

振り返り
========
（ログをもう一回集計して、ここに追記する予定）

データは CC-BY で[公開](https://github.com/hkwi/sacm_cfjs2017) しているので、分析して楽しんでみていただけると、ありがたいです。

